<%
  const formatForInput = (isoString) => {
    if (!isoString) return "";
    // new Date(isoString) gère à la fois une date ISO complète et la date simple passée pour un nouvel event
    return new Date(isoString).toISOString().slice(0, 16);
  };

  // Helper pour convertir un nombre en chaîne hexadécimale #RRGGBB
  const formatColorForInput = (colorNumber) => {
    return "#" + (colorNumber || 0xff0000).toString(16).padStart(6, "0");
  };
%>

<%
    if (action === "delete") {
%>
    <dialog>
        <form hx-post="/events/delete" hx-target="#dialog-container" hx-swap="innerHTML">
            <h3>Supprimer l'événement</h3>
            <input type="hidden" name="id" value="<%= event.id %>">
            <p>Êtes-vous sûr de vouloir supprimer l'événement "<%= event.title %>" ?</p>
            <footer>
            <button type="button" onclick="this.closest('dialog').close()" id="connexionBouton">Annuler</button>
            <button type="submit" id="inscriptionBouton">Supprimer</button>
            </footer>
        </form>
    </dialog>
<%
    }
%>


<dialog>
  <form id="event-form" hx-post="/events" hx-target="#dialog-container" hx-swap="innerHTML">
    <h3><%= action === "add" ? "Ajouter un événement" : "Modifier l'événement" %></h3>
    
    <% if (action === "edit") { %>
      <input type="hidden" name="id" value="<%= event.id %>">
    <% } %>

    <div>
      <label for="title">Titre</label>
      <input type="text" id="title" name="title" value="<%= event.title || '' %>" required>
    </div>

    <div>
      <label for="agenda">Agenda</label>
      <select id="agenda" name="id_agenda" required
        style="background-color: white; color: black; border: 1px solid #ccc; border-radius: 4px; padding: 6px;">
        <% agendas.forEach(agenda =>{ %>
          <option value="<%= agenda.id %>" <%= event.id_agenda === agenda.id ? 'selected' : '' %>
                          style="background-color: white; color: black;">
            <%= agenda.nom %>
          </option>
        <% }) %>
      </select>
    </div>
 
    <div>
      <label for="start">Début</label>
      <!-- Pour un nouvel événement, event.start est null, on utilise 'date' -->
      <input type="datetime-local" id="start" name="start" value="<%= formatForInput(event.start || '') %>" required>
    </div>

    <div>
      <label for="end">Fin</label>
      <input type="datetime-local" id="end" name="end" value="<%= formatForInput(event.end || '') %>" required>
    </div>
    
    <div>
      <label for="description">Description</label>
      <textarea id="description" name="description"><%= event.description || '' %></textarea>
    </div>

    <div>
      <label for="color">Couleur</label>
      <input type="color" id="color" name="color" value="<%= formatColorForInput(event.color) %>">
    </div>
    
    <footer>
      <button type="button" onclick="this.closest('dialog').close()" id="connexionBouton">Annuler</button>
      <% if (action === "edit") { %>
        <button
            type="button"
            id="inscriptionBouton"
            hx-get="/dialog/event-form?action=delete&id=<%= event.id %>&title=<%= event.title %>"
            hx-target="#dialog-container"
            hx-swap="innerHTML">
          Supprimer
        </button>
      <% } %>
      <button type="submit" id="inscriptionBouton">Enregistrer</button>
    </footer>
  </form>
  <script>
   (() => {
       const form = document.getElementById("event-form");
       const startInput = document.getElementById("start");
       const endInput = document.getElementById("end");

       form.addEventListener('submit', (event) => {
           const startDate = startInput.value;
           const endDate = endInput.value;

           if (startDate && endDate && endDate < startDate) {
               event.preventDefault();

               const invalidDate = new Date(endDate);
               const formattedDate = invalidDate.toLocaleString('fr-FR', { 
                   dateStyle: 'medium', 
                   timeStyle: 'short' 
               });

               alert(`La date de fin ne peut pas être antérieure à la date de début.\nDate de fin invalide : ${formattedDate}.`);
               startInput.value = '';
               endInput.value = '';
           }
       });
   })();
  </script>
</dialog>
