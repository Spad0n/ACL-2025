<dialog id="search-dialog">
    <form id="event-form" method="post">
        <h3>Recherche</h3>
        <div>
            <label for="query">Requête</label>
            <input type="text" id="query" name="query" required autocomplete="off">
        </div>
        <div id="search-results"></div>
        <footer>
            <button type="button" onclick="this.closest('dialog').close()" id="connexionBouton">Annuler</button>
            <button type="submit" id="inscriptionBouton">Rechercher</button>
        </footer>
    </form>

    <script>
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        const dialog = document.getElementById('search-dialog');
        const queryInput = dialog.querySelector('#query');
        const resultsContainer = dialog.querySelector('#search-results');

        const performSearch = async (query) => {
            if (query.length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }
            try {
                const response = await fetch(`/events/search-events?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('Erreur serveur');

                const events = await response.json();
                displayResults(events);
            } catch (error) {
                console.error('Erreur:', error);
                resultsContainer.innerHTML = '<p>Erreur lors de la recherche.</p>';
            }
        };

        const debouncedSearch = debounce(performSearch, 300);
        queryInput.addEventListener('input', (e) => {
            debouncedSearch(e.target.value);
        });

        function displayResults(events) {
            if (events.length === 0) {
                resultsContainer.innerHTML = '<p>Aucun événement trouvé.</p>';
                return;
            }
            const resultsHtml = events.map(event => {
                const eventDate = new Date(event.start).toLocaleDateString('fr-FR', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
                return `<li><strong>${event.title}</strong> (${eventDate})</li>`;
            }).join('');
            resultsContainer.innerHTML = `<ul>${resultsHtml}</ul>`;
        }
    </script>
</dialog>