<!DOCTYPE html>
<html lang="fr">
    <head>
      <meta charset="utf-8">
      <link rel="stylesheet" href="/css/importerdeporter.css">
        <title> Importation/Déportation </title>
    </head>

    <body>
        <script>
          function deporter(agendaName) {
	      const obj = { agenda: agendaName};
	      // On va envoyer au serveur la selection de l'utilisateur.
	      fetch('/importerDeporter/agendaDeporter', {
		  method: "POST",
		  headers: {
		      "Content-Type": "application/json",
		  },
		  body: JSON.stringify(obj)
	      })
		  .then( response => response.json())
	          .then( result => {
		      console.log('Réponse du serveur : ', result.message);

		      // on demande à télécharger la ressource
		      const downName = agendaName + "-JSON.json" ;
		      window.location.href = `/download/agenda/${downName}`;
		      
		  })
		  .catch(err => console.error(err));
	    }
	  
            // on ajoute l'ecouteur sur le bouton quand le DOM est lodaed
            document.addEventListener('DOMContentLoaded', () => {
                 document.getElementById('fileButton2')
                    .addEventListener('click', () => {

			// On récupère le nom de l'agenda dans le DOM
			const select         = document.getElementById('selectionAgendaDeporter');
			const agendaTxt      = select.options[select.selectedIndex].text;

			// fonction défini au dessus
                        deporter(agendaTxt);
                    });

		document.getElementById('fileButton1')
		    .addEventListener('click', () => {
			// On récupère le fichier du client
			const fichierJson = document.getElementById('fileOpen').files[0];

			if(!fichierJson) {
			    console.log('fichier est null');
			}
			else {

			    // On va le convertir en objet et l'envoyer au serveur
			    const fr  = new FileReader();
			    fr.onload = (e) => {
				
				const agendaObj = JSON.parse(e.target.result);
				// console.log('Objet converti : ', agendaObj);

				fetch('/importerDeporter/agendaImporter',{
				    method: "POST",
				    headers: {
					"Content-Type": "application/json"
				    },
				    body: JSON.stringify(agendaObj)
				})
				    .then( response => console.log('agenda importé!'))
				    .catch(error => console.error(error));
			    };

			    // (permet d'appeler la méthode onload au dessus)
			    fr.readAsText(fichierJson);
			}
		    });
            });
          
        </script>
	
        <div class='container'>
            Sur cette page, vous pouvez importer ou bien déporter un fichier agenda.
            Ce fichier doit uniquement avoir été déporté/créé par notre page de déportation ici présente dans le cadre d'une importation. 
        </div> 
        <div class='container'>
	  Ici vous pouvez choisir un agenda à importer.
	  <input type="file" id="fileOpen" accept=".json">
	  <button id="fileButton1" name="fileButton1"> Importer </button>
        </div class='container'>
	
        <div class='container'>
            <label for='selectionAgendaDeporter'> Choisir un agenda à déporter : </label>
            <select id="selectionAgendaDeporter">
                <% data.forEach(item => { %>
                <option value="<%= item.id %>">
                    <%= item.nom %>
                </option>
                <% }) %>
            </select>
	    <button id="fileButton2" name="fileButton2"> Deporter </button>
        </div>
    </body>
</html>
