<!-- views/dialog.ejs -->
<% 
const icons = {
    close: `<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" fill="var(--white2)"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>`,
    clock: `<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" fill="var(--white3)"><path d="m15.3 16.7 1.4-1.4-3.7-3.7V7h-2v5.4ZM12 22q-2.075 0-3.9-.788-1.825-.787-3.175-2.137-1.35-1.35-2.137-3.175Q2 14.075 2 12t.788-3.9q.787-1.825 2.137-3.175 1.35-1.35 3.175-2.138Q9.925 2 12 2t3.9.787q1.825.788 3.175 2.138 1.35 1.35 2.137 3.175Q22 9.925 22 12t-.788 3.9q-.787 1.825-2.137 3.175-1.35 1.35-3.175 2.137Q14.075 22 12 22Zm0-10Zm0 8q3.325 0 5.663-2.337Q20 15.325 20 12t-2.337-5.663Q15.325 4 12 4T6.338 6.337Q4 8.675 4 12t2.338 5.663Q8.675 20 12 20Z"/></svg>`,
    prev: `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="var(--white3)"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>`,
    next: `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="var(--white3)"><path d="M8.59 16.59L10 18l6-6-6-6L8.59 7.41 13.17 12z"/></svg>`
};
%>

<dialog id="active-dialog" class="entries__form" style="position: fixed; inset: 0; margin: auto; z-index: 1011;">
    
    <% if (action === "delete") { %>
        <form hx-post="/events/delete" hx-target="#dialog-container" hx-swap="innerHTML" class="entry-form">
            <div class="entries__form--body">
                <div class="form--body__title"><h3 style="color:var(--white1)">Delete ?</h3></div>
                <div class="form--body__description"><p style="color:var(--white2)">Confirm deletion of "<%= event.title %>"</p></div>
                <input type="hidden" name="id" value="<%= event.id %>">
            </div>
            <div class="entries__form--footer">
                <button type="button" class="form--footer__button-cancel" onclick="document.getElementById('dialog-container').innerHTML=''">Cancel</button>
                <button type="submit" class="form--footer__button-save" style="background-color: var(--red1);">Delete</button>
            </div>
        </form>
    <% } else { %>

    <form id="main-form" hx-post="/events" hx-target="#dialog-container" hx-swap="innerHTML" class="entry-form" autocomplete="off">
        
        <% if (action === "edit") { %> <input type="hidden" name="id" value="<%= event.id %>"> <% } %>
        
        <input type="hidden" name="start" id="final-start">
        <input type="hidden" name="end" id="final-end">
        
        <!-- Ce champ caché recevra la couleur de l'agenda sélectionné via JS -->
        <!-- <input type="hidden" name="color" id="final-color" value="#4285F4"> -->

        <div class="entries__form--body">
            <div class="form--body__title form-body-single">
                <input type="text" name="title" class="form--body__title-input" placeholder="Add title" value="<%= event.title || '' %>" required>
            </div>
            <div class="form--body__description form-body-single">
                <textarea name="description" class="form--body__description-input" placeholder="Add description"><%= event.description || '' %></textarea>
            </div>

            <!-- DATES -->
            <div class="form--body__start form-body-double">
                <div class="form--body__start-icon"><%- icons.clock %></div>
                <div class="form--body__start-inputs" style="position: relative;">
                    <span class="form--body-start__date" id="trigger-date-start">...</span>
                    <div class="form-br"></div>
                    <span class="form--body-start__time" id="trigger-time-start">...</span>
                </div>
            </div>
            <div class="form--body__start form-body-double">
                <div class="form--body__start-icon"><%- icons.clock %></div>
                <div class="form--body__start-inputs" style="position: relative;">
                    <span class="form--body-end__date" id="trigger-date-end">...</span>
                    <div class="form-br"></div>
                    <span class="form--body-end__time" id="trigger-time-end">...</span>
                </div>
            </div>

            <!-- AGENDA SELECTION -->
            <div style="padding: 0 4px 12px 0px;">
                <label for="agenda" style="color:var(--white3); font-size:12px; display:block; margin-bottom:4px;">Calendar</label>
                
                <!-- On ajoute data-color sur chaque option -->
                <select id="agenda-select" name="id_agenda" required 
                        style="background-color: var(--black2); color: var(--white1); border: 1px solid var(--mediumgrey1); border-radius: 4px; padding: 6px; width:100%;">
                    <% if (agendas && agendas.length > 0) { %>
                        <% agendas.forEach(agenda => { 
                            // Conversion de la couleur (int) en Hex string pour l'attribut data
                            const hexColor = '#' + (agenda.color || 0x4285F4).toString(16).padStart(6, '0');
                        %>
                            <option value="<%= agenda.id %>" 
                                    data-color="<%= hexColor %>"
                                    <%= event.id_agenda === agenda.id ? 'selected' : '' %> >
                                <%= agenda.nom %>
                            </option>
                        <% }) %>
                    <% } else { %>
                        <option value="" disabled selected>No calendar available</option>
                    <% } %>
                </select>
            </div>
        </div>

        <div class="entries__form--footer">
            <% if (action === "edit") { %>
                <button type="button" class="form--footer__button-cancel" style="border-color: var(--red2); color: var(--red1); width: auto; margin-right: auto; margin-left:15px ;padding: 5px;"
                    hx-get="/dialog/event-form?action=delete&id=<%= event.id %>&title=<%= event.title %>"
                    hx-target="#dialog-container" hx-swap="innerHTML">Delete</button>
            <% } %>
            <button type="button" class="form--footer__button-cancel" onclick="document.getElementById('dialog-container').innerHTML=''">Cancel</button>
            <button type="submit" class="form--footer__button-save">Save</button>
        </div>
    </form>

    <!-- DATEPICKER & TIMEPICKER (Inchangés, je les laisse masqués pour la concision du bloc mais ils doivent être là) -->
    <aside id="custom-datepicker" class="datepicker hide-datepicker" style="position: absolute; z-index: 1050;">
        <div class="datepicker__header">
            <div class="datepicker-title" id="dp-title">Mois</div>
            <div class="datepicker-nav">
                <div class="datepicker-nav--prev" id="dp-prev"><%- icons.prev %></div>
                <div class="datepicker-nav--next" id="dp-next"><%- icons.next %></div>
            </div>
        </div>
        <div class="datepicker__body">
            <div class="datepicker__body--header">
                <div class="datepicker__body--header-cell">D</div><div class="datepicker__body--header-cell">L</div><div class="datepicker__body--header-cell">M</div><div class="datepicker__body--header-cell">M</div><div class="datepicker__body--header-cell">J</div><div class="datepicker__body--header-cell">V</div><div class="datepicker__body--header-cell">S</div>
            </div>
            <div class="datepicker__body--dates" id="dp-grid"></div>
        </div>
    </aside>
    <aside id="custom-timepicker" class="timepicker hide-datepicker" style="position: absolute; z-index: 2000; display: none;">
      <div class="timepicker-times__container" id="tp-list"></div>
    </aside>
    <div id="popup-overlay" style="position: fixed; top:0; left:0; width:100%; height:100%; z-index:1049; display:none;"></div>
    <!-- FIN POPUPS -->

    <% } %>

    <script>
     (function() {
         const form = document.getElementById('main-form');
         if (!form) return; 

         // --- STATE ---
         const rawStart = "<%= event.start || new Date().toISOString() %>";
         const rawEnd = "<%= event.end || new Date(Date.now() + 3600000).toISOString() %>";

         let startDate = new Date(rawStart);
         let endDate = new Date(rawEnd);
         
         // Sécurité si dates invalides
         if (isNaN(startDate.getTime())) startDate = new Date();
         if (isNaN(endDate.getTime())) endDate = new Date(startDate.getTime() + 3600000);

         let dpCurrentDate = new Date(startDate);
         let activeDateInput = 'start'; 

         // --- DOM ELEMENTS ---
         const els = {
             trigDStart: document.getElementById('trigger-date-start'),
             trigTStart: document.getElementById('trigger-time-start'),
             trigDEnd: document.getElementById('trigger-date-end'),
             trigTEnd: document.getElementById('trigger-time-end'),
             
             datepicker: document.getElementById('custom-datepicker'),
             dpTitle: document.getElementById('dp-title'),
             dpGrid: document.getElementById('dp-grid'),
             dpPrev: document.getElementById('dp-prev'),
             dpNext: document.getElementById('dp-next'),
             
             timepicker: document.getElementById('custom-timepicker'),
             tpList: document.getElementById('tp-list'),
             
             overlay: document.getElementById('popup-overlay'),
             finalStart: document.getElementById('final-start'),
             finalEnd: document.getElementById('final-end'),
             
             //agendaSelect: document.getElementById('agenda-select'),
             //finalColor: document.getElementById('final-color'),
             dotPreview: document.getElementById('agenda-preview-dot')
         };

         // --- HELPER FORMATS ---
         const fmtDate = (d) => new Intl.DateTimeFormat('fr-FR', { month: 'short', day: 'numeric', year: 'numeric' }).format(d);
         const fmtTime = (d) => {
             let h = d.getHours().toString().padStart(2, '0');
             let m = d.getMinutes().toString().padStart(2, '0');
             return h + ':' + m;
         };

         // --- LOGIQUE COULEUR AGENDA ---
         //function updateColorFromAgenda() {
         //    if (!els.agendaSelect || !els.finalColor) return;
         //    const selectedOption = els.agendaSelect.options[els.agendaSelect.selectedIndex];
         //    if (selectedOption) {
         //        const color = selectedOption.getAttribute('data-color');
         //        els.finalColor.value = color;
         //        if (els.dotPreview) els.dotPreview.style.backgroundColor = color;
         //    }
         //}
         //if (els.agendaSelect) els.agendaSelect.addEventListener('change', updateColorFromAgenda);

         // --- UI UPDATE ---
         function updateUI() {
             if (els.trigDStart) els.trigDStart.textContent = fmtDate(startDate);
             if (els.trigTStart) els.trigTStart.textContent = fmtTime(startDate);
             if (els.trigDEnd) els.trigDEnd.textContent = fmtDate(endDate);
             if (els.trigTEnd) els.trigTEnd.textContent = fmtTime(endDate);

             // Mise à jour des styles actifs
             if (els.trigDStart) els.trigDStart.classList.toggle('active-form-date', activeDateInput === 'start' && (!els.datepicker.classList.contains('hide-datepicker')));
             if (els.trigDEnd) els.trigDEnd.classList.toggle('active-form-date', activeDateInput === 'end' && (!els.datepicker.classList.contains('hide-datepicker')));
             
             // Mise à jour des inputs cachés
             if (els.finalStart) els.finalStart.value = startDate.toISOString();
             if (els.finalEnd) els.finalEnd.value = endDate.toISOString();
         }

         // --- DATEPICKER LOGIC ---
         function renderCalendar(dateObj) {
             if (!els.dpTitle || !els.dpGrid) return;
             const year = dateObj.getFullYear();
             const month = dateObj.getMonth();
             els.dpTitle.textContent = new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(dateObj);
             els.dpGrid.innerHTML = '';
             const firstDay = new Date(year, month, 1).getDay();
             const daysInMonth = new Date(year, month + 1, 0).getDate();
             
             for (let i = 0; i < firstDay; i++) {
                 const cell = document.createElement('div');
                 cell.className = 'datepicker__body--dates-cell';
                 els.dpGrid.appendChild(cell);
             }
             for (let d = 1; d <= daysInMonth; d++) {
                 const cell = document.createElement('div');
                 cell.className = 'datepicker__body--dates-cell';
                 const span = document.createElement('div');
                 span.className = 'datepicker__body--datename';
                 span.textContent = d;
                 
                 span.onclick = (e) => {
                     e.stopPropagation();
                     const newDate = new Date(activeDateInput === 'start' ? startDate : endDate);
                     newDate.setFullYear(year); newDate.setMonth(month); newDate.setDate(d);
                     
                     if (activeDateInput === 'start') {
                         const diff = endDate - startDate;
                         startDate = newDate;
                         // Si la date de fin devient antérieure, on décale la fin
                         if (endDate < startDate) endDate = new Date(startDate.getTime() + Math.max(diff, 3600000));
                     } else {
                         // Si la date de fin est avant le début, on ramène le début
                         if (newDate < startDate) startDate = new Date(newDate);
                         endDate = newDate;
                     }
                     updateUI(); closePopups();
                 };
                 cell.appendChild(span);
                 els.dpGrid.appendChild(cell);
             }
         }

         // --- TIMEPICKER LOGIC (AJOUTÉE) ---
         function renderTimepicker() {
             if (!els.tpList) return;
             els.tpList.innerHTML = '';
             
             // Génération des créneaux toutes les 15 minutes
             for (let h = 0; h < 24; h++) {
                 for (let m = 0; m < 60; m += 15) {
                     const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                     const div = document.createElement('div');
                     div.className = 'timepicker-time-item'; // Assurez-vous d'avoir du CSS pour cette classe (padding, hover, etc.)
                     div.textContent = timeStr;
                     
                     // Style basique si pas de CSS défini
                     div.style.padding = "8px 16px";
                     div.style.cursor = "pointer";
                     div.style.color = "var(--white1)";
                     div.onmouseover = () => div.style.backgroundColor = "var(--white3)";
                     div.onmouseout = () => div.style.backgroundColor = "transparent";

                     div.onclick = (e) => {
                         e.stopPropagation();
                         const targetDate = activeDateInput === 'start' ? startDate : endDate;
                         targetDate.setHours(h);
                         targetDate.setMinutes(m);
                         
                         if (activeDateInput === 'start') {
                             // Si on change le début et que ça dépasse la fin, on pousse la fin d'1h
                             if (startDate > endDate) {
                                 endDate = new Date(startDate.getTime() + 3600000);
                             }
                         } else {
                             // Si on change la fin et que c'est avant le début, on recule le début
                             if (endDate < startDate) {
                                 startDate = new Date(endDate.getTime() - 3600000);
                             }
                         }
                         updateUI();
                         closePopups();
                     };
                     els.tpList.appendChild(div);
                 }
             }
         }

         // Fonction générique d'ouverture (Date ou Time)
         function openPopup(type, inputType, triggerEl) {
             if (!els.overlay) return;
             
             closePopups(); // Fermer les autres

             activeDateInput = inputType;
             const rect = triggerEl.getBoundingClientRect();
             const dialogRect = form.closest('dialog').getBoundingClientRect();
             
             // Position horizontale (gauche)
             const leftPos = (rect.left - dialogRect.left) + 'px';

             if (type === 'date') {
                 if (!els.datepicker) return;
                 
                 dpCurrentDate = new Date(inputType === 'start' ? startDate : endDate);
                 renderCalendar(dpCurrentDate);

                 // 1. On rend le datepicker visible mais transparent pour mesurer sa hauteur
                 els.datepicker.style.visibility = 'hidden';
                 els.datepicker.classList.remove('hide-datepicker'); 
                 const dpHeight = els.datepicker.offsetHeight;
                 els.datepicker.style.visibility = 'visible';

                 // 2. Logique de positionnement
                 const spaceBelow = window.innerHeight - rect.bottom;
                 
                 // Si c'est le champ 'end' OU s'il y a moins de 300px en bas, on met au-dessus
                 if (inputType === 'end' || spaceBelow < dpHeight) {
                     // Position au-dessus : Top du champ - Hauteur datepicker - 5px de marge
                     els.datepicker.style.top = (rect.top - dialogRect.top - dpHeight - 5) + 'px';
                 } else {
                     // Position en dessous (comportement par défaut)
                     els.datepicker.style.top = (rect.bottom - dialogRect.top + 5) + 'px';
                 }

                 els.datepicker.style.left = leftPos;

             } else if (type === 'time') {
                 // Même logique pour le timepicker si vous le souhaitez
                 if (!els.timepicker) return;
                 renderTimepicker();
                 
                 els.timepicker.style.display = 'block'; // On affiche pour mesurer
                 const tpHeight = 200; // Hauteur approximative ou fixée en CSS
                 
                 const spaceBelow = window.innerHeight - rect.bottom;

                 if (inputType === 'end' || spaceBelow < tpHeight) {
                     els.timepicker.style.top = (rect.top - dialogRect.top - tpHeight - 5) + 'px';
                 } else {
                     els.timepicker.style.top = (rect.bottom - dialogRect.top + 5) + 'px';
                 }
                 
                 els.timepicker.style.left = leftPos;
                 
                 // Scroll automatique
                 const currentHour = (inputType === 'start' ? startDate : endDate).getHours();
                 if(els.tpList) els.tpList.scrollTop = currentHour * 4 * 34; 
             }
             
             els.overlay.style.display = 'block';
             updateUI();
         }

         // --- EVENT LISTENERS ---
         if (els.dpPrev) els.dpPrev.onclick = (e) => { e.stopPropagation(); dpCurrentDate.setMonth(dpCurrentDate.getMonth() - 1); renderCalendar(dpCurrentDate); };
         if (els.dpNext) els.dpNext.onclick = (e) => { e.stopPropagation(); dpCurrentDate.setMonth(dpCurrentDate.getMonth() + 1); renderCalendar(dpCurrentDate); };
         
         function closePopups() {
             if (els.datepicker) els.datepicker.classList.add('hide-datepicker');
             if (els.timepicker) els.timepicker.style.display = 'none';
             if (els.overlay) els.overlay.style.display = 'none';
             // Retirer les classes actives
             if (els.trigDStart) els.trigDStart.classList.remove('active-form-date');
             if (els.trigDEnd) els.trigDEnd.classList.remove('active-form-date');
         }

         // Wiring Clicks
         if (els.trigDStart) els.trigDStart.onclick = (e) => openPopup('date', 'start', e.target);
         if (els.trigDEnd) els.trigDEnd.onclick = (e) => openPopup('date', 'end', e.target);
         
         // AJOUT : Wiring Timepicker
         if (els.trigTStart) els.trigTStart.onclick = (e) => openPopup('time', 'start', e.target);
         if (els.trigTEnd) els.trigTEnd.onclick = (e) => openPopup('time', 'end', e.target);

         if (els.overlay) els.overlay.onclick = closePopups;

         // Init
         updateUI(); 

         const dialog = document.getElementById('active-dialog');
         if (dialog) {
             dialog.showModal();
         }

     })();
    </script>
</dialog>
<style>
    dialog::backdrop {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(2px);
    }
</style>
